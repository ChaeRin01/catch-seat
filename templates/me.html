{% extends "base.html" %}
{% block content %}

<style>
  .me-page{
    padding-top: 10px;
    min-height: calc(100vh - 160px);
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .me-header{
    width: 100%;
    max-width: 960px;
    margin-bottom: 8px;
  }

  .me-title{
    width: 100%;
    max-width: 820px;
    margin: 0 0 14px;
    font-size: 1.5rem;
    font-weight: 700;
  }

  .me-sub{
    margin: 0;
    font-size: 0.85rem;
    color: #6b7280;
  }

  .me-section{
    width: 100%;
    max-width: 960px;
    margin-top: 18px;
  }

  .me-section h2{
    font-size: 1.05rem;
    margin: 0 0 8px;
    font-weight: 600;
    color: #111827;
  }

  .me-empty{
    font-size: 0.9rem;
    color: #6b7280;
    margin: 4px 0 0;
  }

  /* ê³µìš© í…Œì´ë¸” ë˜í¼: ë‘ í…Œì´ë¸” í­Â·ìŠ¤íƒ€ì¼ í†µì¼ */
  .table-wrap{
    width: 100%;
    max-width: 960px;
    overflow-x: auto;
    border-radius: 12px;
    border: 1px solid #e5e7eb;
    background: #ffffff;
    box-shadow: 0 12px 28px rgba(15,23,42,0.06);
  }

  table{
    width: 100%;
    border-collapse: collapse;
    font-size: 0.88rem;
    table-layout: auto;
  }

  thead th{
    background: #f9fafb;
    font-weight: 600;
    color: #374151;
    border-bottom: 1px solid #e5e7eb;
    padding: 9px 10px;
    text-align: left;
    white-space: nowrap;
  }

  tbody td{
    padding: 8px 10px;
    border-bottom: 1px solid #f3f4f6;
    white-space: nowrap; /* ë‚´ìš© ì¤„ë°”ê¿ˆ ì—†ì´ í•œ ì¤„ì— */
    font-size: 0.86rem;
    color: #111827;
  }

  tbody tr:last-child td{
    border-bottom: none;
  }

  /* ì•Œë¦¼ ë°œì†¡ ì™„ë£Œëœ í•­ëª© íšŒìƒ‰ ì²˜ë¦¬ */
  .alert-done{
    background-color: #f9fafb;
    color: #6b7280;
  }

  .alert-done td{
    color: #6b7280;
  }

  /* ì‚­ì œ ë²„íŠ¼ ì‘ê³  ì •ë¦¬ëœ ìŠ¤íƒ€ì¼ */
  table button{
    padding: 4px 10px;
    font-size: 0.78rem;
    border-radius: 6px;
  }

  /* ë¡œê·¸ì•„ì›ƒ ìš°ì¸¡ í•˜ë‹¨ ì •ë ¬ */
  .me-logout{
    width: 100%;
    max-width: 960px;
    margin-top: 20px;
    text-align: right;
    font-size: 0.9rem;
  }

  .me-logout a{
    text-decoration: none;
  }

  @media (max-width: 640px){
    .me-header,
    .me-section,
    .me-logout{
      max-width: 100%;
    }
    .me-title{
      font-size: 1.3rem;
    }
    thead th,
    tbody td{
      padding: 7px 8px;
    }
  }
</style>

<main class="me-page">
  <header class="me-header">
    <h1 class="me-title">ğŸ‘¤ ë§ˆì´í˜ì´ì§€</h1>
    <p class="me-sub">ë‚´ê°€ ë“±ë¡í•œ ì˜ˆë§¤ ì˜¤í”ˆ ì•Œë¦¼ê³¼ ì¢Œì„ ì·¨ì†Œ ì•Œë¦¼ì„ í•œ ë²ˆì— í™•ì¸í•  ìˆ˜ ìˆì–´ìš”.</p>
  </header>

  <section class="me-section">
    <h2>ğŸ¬ ì˜¤í”ˆ ì•Œë¦¼</h2>

    {% if my_open %}
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>ì•Œë¦¼ í‚¤ì›Œë“œ</th>
              <th>ê·¹ì¥</th>
              <th>ìƒì˜ê´€</th>
              <th>ê´€ëŒ ë‚ ì§œ</th>
              <th>ì‹ ì²­ì¼</th>
              <th>ì•Œë¦¼ ìƒíƒœ</th>
              <th></th>  {# ì‚­ì œ ë²„íŠ¼ ì»¬ëŸ¼ (ì•¡ì…˜ ë¬¸êµ¬ ì œê±°) #}
            </tr>
          </thead>
          <tbody>
            {% for a in my_open %}
            {# ì•Œë¦¼ ë°œì†¡ ì™„ë£Œ ì—¬ë¶€ ì¶”ì •: ì¡´ì¬í•  ìˆ˜ ìˆëŠ” í•„ë“œë“¤ì„ ìµœëŒ€í•œ í™œìš© #}
            {% set open_done = (
                (a.notified_at is defined and a.notified_at) or
                (a.sent_at is defined and a.sent_at) or
                (a.is_active is defined and not a.is_active) or
                (a.status is defined and a.status == 'DONE')
              )
            %}
            <tr class="{% if open_done %}alert-done{% endif %}">
              <td>{{ a.id }}</td>
              <!-- a.movie = ì‚¬ìš©ìê°€ ì…ë ¥í•œ ì•Œë¦¼ í‚¤ì›Œë“œ -->
              <td>{{ a.movie }}</td>
              <td>{{ a.theater_name or a.theater }}</td>
              <td>{{ a.screen or "-" }}</td>

              <!-- ê´€ëŒ ë‚ ì§œ: MovieOpenAlert.date = "YYYYMMDD" -->
              <td>
                {% if a.date %}
                  {{ a.date[:4] }}-{{ a.date[4:6] }}-{{ a.date[6:8] }}
                {% else %}
                  -
                {% endif %}
              </td>

              <!-- ì‹ ì²­ì¼: created_atì—ì„œ ì—°-ì›”-ì¼ë§Œ -->
              <td>
                {% if a.created_at %}
                  {{ a.created_at.strftime('%Y-%m-%d') }}
                {% else %}
                  -
                {% endif %}
              </td>

              <!-- ì•Œë¦¼ ìƒíƒœ: ë°œì†¡ ì™„ë£Œ ì—¬ë¶€ í‘œì‹œ -->
              <td>
                {% if open_done %}
                  ë°œì†¡ ì™„ë£Œ!
                {% else %}
                  -
                {% endif %}
              </td>

              <!-- ì‚­ì œ ë²„íŠ¼: í•­ìƒ ë§¨ ì˜¤ë¥¸ìª½ -->
              <td>
                <form method="post" action="/me/open/{{ a.id }}/delete" style="display:inline">
                  <button type="submit">ì‚­ì œ</button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="me-empty">ë“±ë¡í•œ ì˜¤í”ˆ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>
    {% endif %}
  </section>

  <section class="me-section">
    <h2>ğŸ’º ì¢Œì„ ì·¨ì†Œ ì•Œë¦¼</h2>

    {% if my_seat %}
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>ì˜í™”</th>
              <th>ê·¹ì¥</th>
              <th>ì¼ì‹œ</th>
              <th>ì›í•˜ëŠ” ì¢Œì„ ìˆ˜</th>
              <th>ì‹ ì²­ì¼</th>
              <th>ì•Œë¦¼ ìƒíƒœ</th>
              <th></th>  {# ì‚­ì œ ë²„íŠ¼ ì»¬ëŸ¼ (ì•¡ì…˜ ë¬¸êµ¬ ì œê±°) #}
            </tr>
          </thead>
          <tbody>
            {% for a in my_seat %}
            {# ì¢Œì„ ì·¨ì†Œ ì•Œë¦¼ ë°œì†¡ ì™„ë£Œ ì—¬ë¶€ ì¶”ì • #}
            {% set seat_done = (
                (a.notified_at is defined and a.notified_at) or
                (a.sent_at is defined and a.sent_at) or
                (a.is_active is defined and not a.is_active) or
                (a.status is defined and a.status == 'DONE')
              )
            %}
            <tr class="{% if seat_done %}alert-done{% endif %}">
              <td>{{ a.id }}</td>
              <td>{{ a.movie }}</td>
              <td>{{ a.theater_name or a.theater }}</td>
              <td>{{ a.show_datetime }}</td>

              <!-- ì›í•˜ëŠ” ì¢Œì„ ìˆ˜: desired_count ê¸°ì¤€ìœ¼ë¡œ í‘œì‹œ -->
              <td>
                {% if a.desired_count %}
                  {{ a.desired_count }}ì„
                {% else %}
                  -
                {% endif %}
              </td>

              <!-- ì¢Œì„ ì·¨ì†Œ ì‹ ì²­ì¼ë„ ì—°-ì›”-ì¼ë§Œ -->
              <td>
                {% if a.created_at %}
                  {{ a.created_at.strftime('%Y-%m-%d') }}
                {% else %}
                  -
                {% endif %}
              </td>

              <!-- ì•Œë¦¼ ìƒíƒœ: ë°œì†¡ ì™„ë£Œ ì—¬ë¶€ í‘œì‹œ -->
              <td>
                {% if seat_done %}
                  ë°œì†¡ ì™„ë£Œ!
                {% else %}
                  -
                {% endif %}
              </td>

              <!-- ì‚­ì œ ë²„íŠ¼: í•­ìƒ ë§¨ ì˜¤ë¥¸ìª½ -->
              <td>
                <form method="post" action="/me/seat/{{ a.id }}/delete" style="display:inline">
                  <button type="submit">ì‚­ì œ</button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="me-empty">ë“±ë¡í•œ ì¢Œì„ ì·¨ì†Œ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>
    {% endif %}
  </section>

  <div class="me-logout">
    <a href="{{ url_for('logout') }}">ë¡œê·¸ì•„ì›ƒ</a>
  </div>
</main>

{% endblock %}

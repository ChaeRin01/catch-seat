{% extends "base.html" %}
{% block content %}

<style>
  .seat-page{
    padding-top: 10px;
    min-height: calc(100vh - 160px);
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .seat-title{
    width: 100%;
    max-width: 820px;
    margin: 0 0 14px;
    font-size: 1.5rem;
    font-weight: 700;
  }

  .seat-card{
    width: 100%;
    max-width: 820px; /* ì˜¤í”ˆ ì•Œë¦¼ê³¼ ë™ì¼í•œ ë°•ìŠ¤ í¬ê¸° */
    background: #ffffff;
    border-radius: 18px;
    padding: 20px 24px 18px;
    border: 1px solid #e5e7eb;
    box-shadow: 0 16px 32px rgba(15,23,42,0.08);
  }

  .seat-form{
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .seat-field{
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .seat-label{
    font-size: 0.9rem;
    color: #111827;
  }

  .seat-label strong{
    font-weight: 600;
  }

  .seat-input,
  .seat-select{
    border-radius: 10px;
    border: 1px solid #d1d5db;
    padding: 9px 10px;
    font-size: 0.9rem;
    outline: none;
    transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    min-width: 0;
  }

  .seat-input:focus,
  .seat-select:focus{
    border-color: #4f46e5;
    box-shadow: 0 0 0 1px rgba(79,70,229,0.25);
    background: #f9fafb;
  }

  .seat-actions{
    margin-top: 16px;
    text-align: center; /* í•˜ë‹¨ ì‹ ì²­ ë²„íŠ¼ ê°€ìš´ë° ì •ë ¬ */
  }

  /* ìƒë‹¨ ê²€ìƒ‰ ë²„íŠ¼, í•˜ë‹¨ ì‹ ì²­ ë²„íŠ¼ í¬ê¸° í†µì¼ */
  .seat-actions button,
  .seat-search button{
    width: 130px;
    font-size: 0.9rem;
  }

  .seat-search{
    margin-top: 6px;
    display: flex;          /* ë²„íŠ¼ì„ flex ì»¨í…Œì´ë„ˆ ì•ˆì— ë‘ê³  */
    flex-direction: column; /* ì„¸ë¡œ ë°©í–¥ìœ¼ë¡œ ìŒ“ê³  */
    align-items: center;
  }

  hr.seat-divider{
    border: none;
    border-top: 1px solid #e5e7eb;
    margin: 16px 0;
  }

  @media (max-width: 640px){
    .seat-title{
      font-size: 1.3rem;
      max-width: 100%;
      padding: 0 2px;
    }
    .seat-card{
      max-width: 100%;
      padding: 18px 16px 16px;
      border-radius: 16px;
    }
  }
</style>

<main class="seat-page">
  <h1 class="seat-title">ğŸ’º ì¢Œì„ ì·¨ì†Œ ì•Œë¦¼ ì‹ ì²­</h1>

  <section class="seat-card">
    <form method="post" id="seatAlertForm" class="seat-form">
      <!-- ë©”ê°€ë°•ìŠ¤ ì „ìš© ë¸Œëœë“œ (ì‹¤ì œ ì „ì†¡ ê°’) -->
      <input type="hidden" name="brand" value="MEGABOX" />

      <!-- ì˜í™”ì‚¬ (í˜„ì¬ëŠ” ë©”ê°€ë°•ìŠ¤ ê³ ì •) -->
      <div class="seat-field">
        <label for="vendorSelect" class="seat-label"><strong>ì˜í™”ì‚¬</strong></label>
        <select id="vendorSelect" class="seat-select" disabled>
          <option value="megabox" selected>ë©”ê°€ë°•ìŠ¤ (DOLBY CINEMA ì „ìš©)</option>
        </select>
      </div>

      <!-- ì§€ì  ì„ íƒ -->
      <div class="seat-field">
        <label for="theaterSelect" class="seat-label"><strong>ì§€ì </strong></label>
        <select name="theater" id="theaterSelect" class="seat-select" required>
          <option value="">-- ì§€ì  ì„ íƒ --</option>
          {% for code, name in dolby_branches.items() %}
            <option value="{{ code }}">{{ name|replace('ë©”ê°€ë°•ìŠ¤ ', '') }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- ë‚ ì§œ ì„ íƒ -->
      <div class="seat-field">
        <label for="dateInput" class="seat-label"><strong>ê´€ëŒ ë‚ ì§œ</strong></label>
        <input type="date" name="date" id="dateInput" class="seat-input" required />
      </div>

      <!-- ìƒì˜ì •ë³´ ê²€ìƒ‰ ë²„íŠ¼ -->
      <div class="seat-field seat-search">
        <button type="button" id="searchBtn">ìƒì˜ì •ë³´ ê²€ìƒ‰ ğŸ”</button>
      </div>

      <hr class="seat-divider" />

      <!-- ì˜í™” ì„ íƒ -->
      <div class="seat-field">
        <label for="movieSelect" class="seat-label"><strong>ì˜í™”</strong></label>
        <select name="movie" id="movieSelect" class="seat-select" required>
          <option value="">-- ë¨¼ì € ìƒì˜ì •ë³´ë¥¼ ê²€ìƒ‰í•˜ì„¸ìš” --</option>
        </select>
      </div>

      <!-- ìƒì˜ê´€ / ì‹œê°„ ì„ íƒ -->
      <div class="seat-field">
        <label for="showtimeSelect" class="seat-label"><strong>ìƒì˜ê´€ / ì‹œê°„</strong></label>
        <!-- ì‹¤ì œë¡œ ì„œë²„ì— ì „ì†¡ë˜ëŠ” ê°’ì€ hidden inputìœ¼ë¡œ ê´€ë¦¬í•˜ê³ ,
             ì´ selectëŠ” UIìš©ìœ¼ë¡œë§Œ ì‚¬ìš©í•œë‹¤. -->
        <select id="showtimeSelect" class="seat-select" required>
          <option value="">-- ë¨¼ì € ì˜í™”ë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>
        </select>
      </div>

      <!-- ì„œë²„ë¡œ ì „ì†¡ë  ì‹¤ì œ ê°’ë“¤ -->
      <input type="hidden" name="show_datetime" id="showDatetimeInput" />
      <input type="hidden" name="screen" id="screenInput" />

      <!-- ì›í•˜ëŠ” ì¢Œì„ ìˆ˜ -->
      <div class="seat-field">
        <label for="desiredCountInput" class="seat-label"><strong>ì›í•˜ëŠ” ì¢Œì„ ìˆ˜</strong></label>
        <input
          type="number"
          name="desired_count"
          id="desiredCountInput"
          class="seat-input"
          min="1"
          max="10"
          required
          value="1"
          placeholder="ì˜ˆ: 1"
        />
      </div>

      <div class="seat-actions">
        <button type="submit">ì‹ ì²­ ğŸ“¤</button>
      </div>
    </form>
  </section>
</main>

<script>
  // í˜„ì¬ ê²€ìƒ‰ ê²°ê³¼(ë©”ê°€ë°•ìŠ¤ DOLBY ìƒì˜ì •ë³´)ë¥¼ ë©”ëª¨ë¦¬ ìƒì— ìœ ì§€
  let CURRENT_SHOWTIMES = [];

  const theaterEl = document.getElementById("theaterSelect");
  const dateEl = document.getElementById("dateInput");
  const searchBtn = document.getElementById("searchBtn");

  const movieEl = document.getElementById("movieSelect");
  const showtimeEl = document.getElementById("showtimeSelect");

  const showDatetimeInput = document.getElementById("showDatetimeInput");
  const screenInput = document.getElementById("screenInput");

  // ìƒì˜ì •ë³´ ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ â†’ ë©”ê°€ë°•ìŠ¤ DOLBY ìƒì˜ì •ë³´ API í˜¸ì¶œ
  searchBtn.addEventListener("click", async () => {
    const theater = theaterEl.value;
    const date = dateEl.value;

    if (!theater || !date) {
      alert("ì§€ì ê³¼ ë‚ ì§œë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.");
      return;
    }

    // UI ì´ˆê¸°í™”
    CURRENT_SHOWTIMES = [];
    movieEl.innerHTML = '<option value="">-- ìƒì˜ì •ë³´ ë¡œë”© ì¤‘... --</option>';
    showtimeEl.innerHTML = '<option value="">-- ë¨¼ì € ì˜í™”ë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>';
    showDatetimeInput.value = "";
    screenInput.value = "";

    try {
      const params = new URLSearchParams({
        theater: theater,
        date: date,
      });

      const resp = await fetch(`/api/megabox/dolby_showtimes?${params.toString()}`, {
        method: "GET",
        headers: {
          "Accept": "application/json",
        },
      });

      const data = await resp.json();

      if (!data.ok) {
        alert(data.error || "ìƒì˜ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        movieEl.innerHTML = '<option value="">-- ìƒì˜ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤ --</option>';
        return;
      }

      CURRENT_SHOWTIMES = data.showtimes || [];

      if (CURRENT_SHOWTIMES.length === 0) {
        movieEl.innerHTML = '<option value="">-- ì„ íƒí•˜ì‹  ì§€ì /ë‚ ì§œì— DOLBY ìƒì˜ì´ ì—†ìŠµë‹ˆë‹¤ --</option>';
        return;
      }

      // ì˜í™” ë¦¬ìŠ¤íŠ¸ êµ¬ì„± (ì¤‘ë³µ ì œê±°)
      const movieSet = new Set();
      CURRENT_SHOWTIMES.forEach((st) => {
        if (st.movie_title) {
          movieSet.add(st.movie_title);
        }
      });

      movieEl.innerHTML = '<option value="">-- ì˜í™” ì„ íƒ --</option>';
      Array.from(movieSet).forEach((title) => {
        const opt = document.createElement("option");
        opt.value = title;
        opt.textContent = title;
        movieEl.appendChild(opt);
      });

      // ìƒì˜ì‹œê°„ select ì´ˆê¸°í™”
      showtimeEl.innerHTML = '<option value="">-- ë¨¼ì € ì˜í™”ë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>';
      showDatetimeInput.value = "";
      screenInput.value = "";
    } catch (e) {
      console.error(e);
      alert("ë©”ê°€ë°•ìŠ¤ ìƒì˜ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      movieEl.innerHTML = '<option value="">-- ìƒì˜ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤ --</option>';
    }
  });

  // ì˜í™” ì„ íƒ ì‹œ â†’ í•´ë‹¹ ì˜í™”ì˜ ìƒì˜ê´€/ì‹œê°„ ì˜µì…˜ êµ¬ì„±
  movieEl.addEventListener("change", () => {
    const selectedMovie = movieEl.value;
    showtimeEl.innerHTML = '<option value="">-- ìƒì˜ê´€/ì‹œê°„ ì„ íƒ --</option>';
    showDatetimeInput.value = "";
    screenInput.value = "";

    if (!selectedMovie) {
      return;
    }

    const filtered = CURRENT_SHOWTIMES.filter(
      (st) => st.movie_title === selectedMovie
    );

    filtered.forEach((st, idx) => {
      const opt = document.createElement("option");
      opt.value = String(idx);
      opt.textContent = `${st.start_time} / ${st.screen_name} / ${st.seats_status}`;
      opt.dataset.screenName = st.screen_name || "";
      opt.dataset.startTime = st.start_time || "";
      showtimeEl.appendChild(opt);
    });

    if (filtered.length === 0) {
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "-- ì„ íƒ ê°€ëŠ¥í•œ ìƒì˜ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤ --";
      showtimeEl.appendChild(opt);
    }
  });

  // ìƒì˜ê´€/ì‹œê°„ ì„ íƒ ì‹œ â†’ hidden inputì— ì‹¤ì œ ê°’ ì„¸íŒ…
  showtimeEl.addEventListener("change", () => {
    const sel = showtimeEl.selectedOptions[0];
    if (!sel) {
      showDatetimeInput.value = "";
      screenInput.value = "";
      return;
    }

    const date = dateEl.value;
    const startTime = sel.dataset.startTime || "";
    const screenName = sel.dataset.screenName || "";

    if (date && startTime) {
      // ì„œë²„ì—ëŠ” "YYYY-MM-DD HH:MM" í˜•ì‹ìœ¼ë¡œ ì „ë‹¬
      showDatetimeInput.value = `${date} ${startTime}`;
    } else {
      showDatetimeInput.value = "";
    }
    screenInput.value = screenName;
  });

  // í¼ submit ì‹œ, ìƒì˜ì •ë³´ ì„ íƒ ì—¬ë¶€ ê°„ë‹¨ ì²´í¬
  const formEl = document.getElementById("seatAlertForm");
  formEl.addEventListener("submit", (e) => {
    if (!showDatetimeInput.value || !screenInput.value) {
      e.preventDefault();
      alert("ìƒì˜ê´€/ì‹œê°„ì„ ì„ íƒí•œ í›„ ì•Œë¦¼ì„ ì‹ ì²­í•´ì£¼ì„¸ìš”.");
    }
  });
</script>
{% endblock %}
